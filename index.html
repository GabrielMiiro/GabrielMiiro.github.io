<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pack Performance Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #191919;
            color: #e9e9e7;
            margin: 0;
            padding: 16px;
            line-height: 1.4;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2f3437;
            border-radius: 8px;
            border: 1px solid #37352f;
            overflow: hidden;
        }
        
        .header {
            padding: 16px 20px;
            background: #37352f;
            border-bottom: 1px solid #37352f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
        }
        
        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .save-btn, .load-select {
            background: #37352f;
            border: 1px solid #9b9a97;
            color: #e9e9e7;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .save-btn:hover {
            background: #2f3437;
            border-color: #0061cc;
        }
        
        .load-select {
            min-width: 150px;
        }
        
        .tabs {
            display: flex;
            background: #37352f;
            border-bottom: 1px solid #37352f;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #9b9a97;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            color: #ffffff;
            border-bottom-color: #0061cc;
        }
        
        .tab:hover {
            background: #2f3437;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            padding: 20px;
            border-bottom: 1px solid #37352f;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .pack {
            background: #37352f;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .pack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .remove-btn {
            background: none;
            border: none;
            color: #e03e3e;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .input-box {
            display: flex;
            flex-direction: column;
        }
        
        .input-box label {
            font-size: 11px;
            color: #9b9a97;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .input-box input {
            padding: 8px;
            background: #2f3437;
            border: 1px solid #37352f;
            border-radius: 4px;
            color: #e9e9e7;
            font-size: 12px;
        }
        
        .input-box input:focus {
            outline: none;
            border-color: #0061cc;
        }
        
        .name-input {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            width: 200px;
        }
        
        .name-input:focus {
            outline: 1px solid #0061cc;
            border-radius: 2px;
            padding: 2px 4px;
        }
        
        .results {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #2f3437;
        }
        
        .result {
            text-align: center;
        }
        
        .result-label {
            font-size: 10px;
            color: #9b9a97;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .result-value {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-top: 4px;
        }
        
        .btn {
            background: #0f7b6c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }
        
        .btn:hover {
            background: #0d6559;
        }
        
        .btn-secondary {
            background: #0061cc;
        }
        
        .btn-secondary:hover {
            background: #004499;
        }
        
        .comparison {
            display: none;
        }
        
        .comparison.show {
            display: block;
        }
        
        .ranking {
            background: #37352f;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .ranking h4 {
            margin: 0 0 12px 0;
            color: #ffffff;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 12px;
        }
        
        .ranking-item:first-child { color: #0f7b6c; font-weight: 600; }
        .ranking-item:nth-child(2) { color: #d97706; font-weight: 500; }
        .ranking-item:nth-child(3) { color: #6b7280; font-weight: 400; }
        
        .insights {
            background: #37352f;
            border-radius: 6px;
            padding: 16px;
        }
        
        .insights h4 {
            margin: 0 0 12px 0;
            color: #ffffff;
            font-size: 13px;
        }
        
        .insight {
            font-size: 12px;
            color: #e9e9e7;
            margin-bottom: 8px;
            padding-left: 12px;
            border-left: 3px solid #9b9a97;
            line-height: 1.4;
        }
        
        .insight.success { border-left-color: #0f7b6c; }
        .insight.warning { border-left-color: #d9730d; }
        .insight.info { border-left-color: #0061cc; }
        
        .hidden {
            display: none;
        }
        
        .upload-area {
            background: #37352f;
            border: 2px dashed #9b9a97;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #0061cc;
            background: #2f3437;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .upload-text {
            color: #e9e9e7;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .upload-subtext {
            color: #9b9a97;
            font-size: 12px;
        }
        
        .file-input {
            display: none;
        }
        
        .chart-container {
            background: #37352f;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-canvas {
            height: 300px !important;
            max-height: 300px;
        }
        
        .stat-card {
            background: #37352f;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .stat-label {
            font-size: 11px;
            color: #9b9a97;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .top-template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #2f3437;
            font-size: 12px;
        }
        
        .top-template-item:last-child {
            border-bottom: none;
        }
        
        .top-template-rank {
            font-weight: 600;
            color: #9b9a97;
            margin-right: 12px;
        }
        
        .top-template-name {
            flex: 1;
            color: #e9e9e7;
        }
        
        .top-template-value {
            font-weight: 600;
            color: #ffffff;
        }
        
        .rank-1 .top-template-rank { color: #0f7b6c; }
        .rank-2 .top-template-rank { color: #d97706; }
        .rank-3 .top-template-rank { color: #9065b0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Pack Performance Analyzer</h1>
            <div class="header-controls">
                <button class="save-btn" onclick="saveAnalysis()">ðŸ’¾ Save Analysis</button>
                <select class="load-select" onchange="loadAnalysis(this.value)">
                    <option value="">Load Saved Analysis...</option>
                </select>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('pack-comparison')">Pack Comparison</button>
            <button class="tab" onclick="switchTab('time-series')">Template Usage Over Time</button>
        </div>
        
        <!-- Pack Comparison Tab -->
        <div id="pack-comparison" class="tab-content active">
            <div class="section" id="packs-section">
                <div class="pack" id="pack-1">
                    <div class="pack-header">
                        <input type="text" class="name-input" id="name1" placeholder="Pack 1 Name">
                        <span style="display: none;"></span>
                    </div>
                    <div class="inputs">
                        <div class="input-box">
                            <label>Unique Users</label>
                            <input type="number" id="users1" onchange="calc(1)">
                        </div>
                        <div class="input-box">
                            <label>Unique Projects</label>
                            <input type="number" id="projects1" onchange="calc(1)">
                        </div>
                        <div class="input-box">
                            <label>Total App Users</label>
                            <input type="number" id="total1" onchange="calc(1)">
                        </div>
                        <div class="input-box">
                            <label>Banner Clicks</label>
                            <input type="number" id="banner1" onchange="calc(1)">
                        </div>
                    </div>
                    <div class="results">
                        <div class="result">
                            <div class="result-label">% All Users Used Pack</div>
                            <div class="result-value" id="usage1">-</div>
                        </div>
                        <div class="result">
                            <div class="result-label">% Users via Banner</div>
                            <div class="result-value" id="bannerPct1">-</div>
                        </div>
                        <div class="result">
                            <div class="result-label">Projects per User</div>
                            <div class="result-value" id="ppu1">-</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <button class="btn btn-secondary" onclick="addPack()" style="margin-bottom: 12px;">+ Add Pack</button>
                <button class="btn hidden" id="compare-btn" onclick="analyze()">Compare All Packs</button>
            </div>
            
            <div class="section comparison" id="comparison">
                <div id="rankings"></div>
                <div class="insights" id="insights">
                    <h4>Key Insights</h4>
                    <div id="insightsList"></div>
                </div>
            </div>
        </div>
        
        <!-- Time Series Tab -->
        <div id="time-series" class="tab-content">
            <div class="section">
                <div class="upload-area" onclick="document.getElementById('csv-upload').click()">
                    <div class="upload-icon">ðŸ“Š</div>
                    <div class="upload-text">Click to upload CSV file</div>
                    <div class="upload-subtext">Expected format: action_date, template, Num Unique Projects</div>
                </div>
                <input type="file" id="csv-upload" class="file-input" accept=".csv" onchange="handleFileUpload(event)">
            </div>
            
            <div id="time-results" class="hidden">
                <div class="section">
                    <div class="stat-card">
                        <div class="stat-label">Total Templates</div>
                        <div class="stat-value" id="total-templates">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Projects</div>
                        <div class="stat-value" id="total-projects">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Date Range</div>
                        <div class="stat-value" id="date-range" style="font-size: 16px;">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average Daily Projects</div>
                        <div class="stat-value" id="avg-daily" style="font-size: 18px;">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Peak Day</div>
                        <div class="stat-value" id="peak-day" style="font-size: 14px;">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Lowest Day (excl. first)</div>
                        <div class="stat-value" id="worst-day" style="font-size: 14px;">-</div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="insights">
                        <h4>Top 5 Performing Templates (Overall)</h4>
                        <div id="top-templates-list"></div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="insights">
                        <h4>Templates That Reached Daily Top 5</h4>
                        <div id="ever-top5-list"></div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="chart-container">
                        <h4 style="color: #ffffff; margin-bottom: 16px;">Template Usage Over Time (Top 10)</h4>
                        <canvas id="timeChart" class="chart-canvas"></canvas>
                    </div>
                </div>
                
                <div class="section">
                    <div class="insights">
                        <h4>Key Insights</h4>
                        <div id="time-insights"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var packCount = 1;
        var myChart = null;
        
        // Load saved analyses on page load
        window.onload = function() {
            updateSavedAnalysesList();
        };
        
        function saveAnalysis() {
            var name = prompt('Enter a name for this analysis:');
            if (!name) return;
            
            var data = {
                packs: [],
                timestamp: new Date().toISOString()
            };
            
            document.querySelectorAll('.pack').forEach(function(packEl) {
                var id = packEl.id.replace('pack-', '');
                data.packs.push({
                    name: document.getElementById('name' + id).value,
                    users: document.getElementById('users' + id).value,
                    projects: document.getElementById('projects' + id).value,
                    total: document.getElementById('total' + id).value,
                    banner: document.getElementById('banner' + id).value
                });
            });
            
            var saved = JSON.parse(localStorage.getItem('packAnalyses') || '{}');
            saved[name] = data;
            localStorage.setItem('packAnalyses', JSON.stringify(saved));
            
            updateSavedAnalysesList();
            alert('Analysis saved as: ' + name);
        }
        
        function loadAnalysis(name) {
            if (!name) return;
            
            var saved = JSON.parse(localStorage.getItem('packAnalyses') || '{}');
            var data = saved[name];
            if (!data) return;
            
            // Clear existing packs
            document.getElementById('packs-section').innerHTML = '';
            packCount = 0;
            
            // Load saved packs
            data.packs.forEach(function(pack, index) {
                if (index === 0) {
                    packCount = 1;
                    var html = '<div class="pack" id="pack-1">' +
                        '<div class="pack-header"><input type="text" class="name-input" id="name1" placeholder="Pack 1 Name" value="' + (pack.name || '') + '"><span style="display: none;"></span></div>' +
                        '<div class="inputs">' +
                        '<div class="input-box"><label>Unique Users</label><input type="number" id="users1" value="' + (pack.users || '') + '" onchange="calc(1)"></div>' +
                        '<div class="input-box"><label>Unique Projects</label><input type="number" id="projects1" value="' + (pack.projects || '') + '" onchange="calc(1)"></div>' +
                        '<div class="input-box"><label>Total App Users</label><input type="number" id="total1" value="' + (pack.total || '') + '" onchange="calc(1)"></div>' +
                        '<div class="input-box"><label>Banner Clicks</label><input type="number" id="banner1" value="' + (pack.banner || '') + '" onchange="calc(1)"></div>' +
                        '</div>' +
                        '<div class="results">' +
                        '<div class="result"><div class="result-label">% All Users Used Pack</div><div class="result-value" id="usage1">-</div></div>' +
                        '<div class="result"><div class="result-label">% Users via Banner</div><div class="result-value" id="bannerPct1">-</div></div>' +
                        '<div class="result"><div class="result-label">Projects per User</div><div class="result-value" id="ppu1">-</div></div>' +
                        '</div></div>';
                    document.getElementById('packs-section').innerHTML = html;
                    calc(1);
                } else {
                    addPack();
                    var id = packCount;
                    document.getElementById('name' + id).value = pack.name || '';
                    document.getElementById('users' + id).value = pack.users || '';
                    document.getElementById('projects' + id).value = pack.projects || '';
                    document.getElementById('total' + id).value = pack.total || '';
                    document.getElementById('banner' + id).value = pack.banner || '';
                    calc(id);
                }
            });
            
            // Reset dropdown
            document.querySelector('.load-select').value = '';
        }
        
        function updateSavedAnalysesList() {
            var saved = JSON.parse(localStorage.getItem('packAnalyses') || '{}');
            var select = document.querySelector('.load-select');
            
            // Keep the first option
            select.innerHTML = '<option value="">Load Saved Analysis...</option>';
            
            Object.keys(saved).forEach(function(name) {
                var date = new Date(saved[name].timestamp).toLocaleDateString();
                var option = document.createElement('option');
                option.value = name;
                option.textContent = name + ' (' + date + ')';
                select.appendChild(option);
            });
        }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(function(content) {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
        
        function addPack() {
            packCount++;
            var packsSection = document.getElementById('packs-section');
            var newPack = document.createElement('div');
            newPack.className = 'pack';
            newPack.id = 'pack-' + packCount;
            
            newPack.innerHTML = 
                '<div class="pack-header">' +
                    '<input type="text" class="name-input" id="name' + packCount + '" placeholder="Pack ' + packCount + ' Name">' +
                    '<button class="remove-btn" onclick="removePack(' + packCount + ')">Ã—</button>' +
                '</div>' +
                '<div class="inputs">' +
                    '<div class="input-box"><label>Unique Users</label><input type="number" id="users' + packCount + '" onchange="calc(' + packCount + ')"></div>' +
                    '<div class="input-box"><label>Unique Projects</label><input type="number" id="projects' + packCount + '" onchange="calc(' + packCount + ')"></div>' +
                    '<div class="input-box"><label>Total App Users</label><input type="number" id="total' + packCount + '" onchange="calc(' + packCount + ')"></div>' +
                    '<div class="input-box"><label>Banner Clicks</label><input type="number" id="banner' + packCount + '" onchange="calc(' + packCount + ')"></div>' +
                '</div>' +
                '<div class="results">' +
                    '<div class="result"><div class="result-label">% All Users Used Pack</div><div class="result-value" id="usage' + packCount + '">-</div></div>' +
                    '<div class="result"><div class="result-label">% Users via Banner</div><div class="result-value" id="bannerPct' + packCount + '">-</div></div>' +
                    '<div class="result"><div class="result-label">Projects per User</div><div class="result-value" id="ppu' + packCount + '">-</div></div>' +
                '</div>';
            
            packsSection.appendChild(newPack);
            updateCompareButton();
        }
        
        function removePack(packNum) {
            document.getElementById('pack-' + packNum).remove();
            updateCompareButton();
        }
        
        function updateCompareButton() {
            var packs = document.querySelectorAll('.pack');
            document.getElementById('compare-btn').classList.toggle('hidden', packs.length <= 1);
            if (packs.length <= 1) document.getElementById('comparison').className = 'comparison';
        }
        
        function calc(packNum) {
            var users = parseInt(document.getElementById('users' + packNum).value) || 0;
            var projects = parseInt(document.getElementById('projects' + packNum).value) || 0;
            var total = parseInt(document.getElementById('total' + packNum).value) || 0;
            var banner = parseInt(document.getElementById('banner' + packNum).value) || 0;
            
            document.getElementById('usage' + packNum).textContent = (total > 0 ? ((users / total) * 100).toFixed(2) : 0) + '%';
            document.getElementById('bannerPct' + packNum).textContent = (users > 0 ? ((banner / users) * 100).toFixed(1) : 0) + '%';
            document.getElementById('ppu' + packNum).textContent = users > 0 ? (projects / users).toFixed(2) : 0;
        }
        
        function analyze() {
            var packs = [];
            document.querySelectorAll('.pack').forEach(function(packEl) {
                var id = packEl.id.replace('pack-', '');
                var users = parseInt(document.getElementById('users' + id).value) || 0;
                var projects = parseInt(document.getElementById('projects' + id).value) || 0;
                var total = parseInt(document.getElementById('total' + id).value) || 0;
                var banner = parseInt(document.getElementById('banner' + id).value) || 0;
                var name = document.getElementById('name' + id).value || 'Pack ' + id;
                
                if (users > 0) {
                    packs.push({
                        name: name,
                        usage: total > 0 ? (users / total) * 100 : 0,
                        bannerPct: users > 0 ? (banner / users) * 100 : 0,
                        ppu: projects / users
                    });
                }
            });
            
            if (packs.length < 2) {
                alert('Please enter data for at least 2 packs to compare');
                return;
            }
            
            showComparison(packs);
        }
        
        function showComparison(packs) {
            var usageSort = packs.slice().sort(function(a, b) { return b.usage - a.usage; });
            var ppuSort = packs.slice().sort(function(a, b) { return b.ppu - a.ppu; });
            var bannerSort = packs.slice().sort(function(a, b) { return b.bannerPct - a.bannerPct; });
            
            var html = '<div class="ranking"><h4>% All Users Used Pack</h4>';
            for (var i = 0; i < Math.min(3, usageSort.length); i++) {
                html += '<div class="ranking-item"><span>' + usageSort[i].name + '</span><span>' + usageSort[i].usage.toFixed(2) + '%</span></div>';
            }
            html += '</div><div class="ranking"><h4>Projects per User</h4>';
            for (var i = 0; i < Math.min(3, ppuSort.length); i++) {
                html += '<div class="ranking-item"><span>' + ppuSort[i].name + '</span><span>' + ppuSort[i].ppu.toFixed(2) + '</span></div>';
            }
            html += '</div><div class="ranking"><h4>% Users via Banner</h4>';
            for (var i = 0; i < Math.min(3, bannerSort.length); i++) {
                html += '<div class="ranking-item"><span>' + bannerSort[i].name + '</span><span>' + bannerSort[i].bannerPct.toFixed(1) + '%</span></div>';
            }
            html += '</div>';
            
            document.getElementById('rankings').innerHTML = html;
            
            var insights = [];
            insights.push('success|' + usageSort[0].name + ' leads adoption with ' + usageSort[0].usage.toFixed(2) + '% of all users');
            if (usageSort[0].name !== ppuSort[0].name) {
                insights.push('info|' + ppuSort[0].name + ' has highest engagement (' + ppuSort[0].ppu.toFixed(2) + ' projects/user) but lower adoption');
            }
            if (bannerSort[0].bannerPct > 50) {
                insights.push('success|' + bannerSort[0].name + ' has excellent banner discovery (' + bannerSort[0].bannerPct.toFixed(1) + '%)');
            }
            
            var insightsHtml = insights.map(function(i) {
                var p = i.split('|');
                return '<div class="insight ' + p[0] + '">' + p[1] + '</div>';
            }).join('');
            
            document.getElementById('insightsList').innerHTML = insightsHtml;
            document.getElementById('comparison').className = 'comparison show';
        }
        
        function handleFileUpload(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(event) {
                parseCSV(event.target.result);
            };
            reader.readAsText(file);
        }
        
        function parseCSV(csv) {
            var lines = csv.split('\n');
            var data = {};
            var allDates = [];
            
            for (var i = 1; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                
                var parts = [];
                var current = '';
                var inQuotes = false;
                
                for (var j = 0; j < line.length; j++) {
                    var char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        parts.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                parts.push(current.trim());
                
                if (parts.length < 3) continue;
                
                var date = parts[0].replace(/"/g, '').trim();
                var template = parts[1].replace(/"/g, '').trim();
                var projects = parseInt(parts[2]) || 0;
                
                if (!template || !date) continue;
                
                if (!data[template]) data[template] = {};
                data[template][date] = (data[template][date] || 0) + projects;
                
                if (allDates.indexOf(date) === -1) allDates.push(date);
            }
            
            allDates.sort();
            analyzeData(data, allDates);
        }
        
        function analyzeData(data, dates) {
            var templates = Object.keys(data);
            var totals = [];
            var grandTotal = 0;
            var dailyTotals = {};
            var everTop5 = {};
            
            // Calculate totals and daily totals
            for (var i = 0; i < templates.length; i++) {
                var template = templates[i];
                var total = 0;
                for (var j = 0; j < dates.length; j++) {
                    var date = dates[j];
                    var projectCount = data[template][date] || 0;
                    total += projectCount;
                    dailyTotals[date] = (dailyTotals[date] || 0) + projectCount;
                }
                totals.push({ template: template, total: total });
                grandTotal += total;
            }
            
            totals.sort(function(a, b) { return b.total - a.total; });
            
            // Track which templates were in daily top 5
            dates.forEach(function(date) {
                var dayRankings = templates.map(function(t) {
                    return { template: t, count: data[t][date] || 0 };
                }).sort(function(a, b) { return b.count - a.count; });
                
                for (var i = 0; i < Math.min(5, dayRankings.length); i++) {
                    var template = dayRankings[i].template;
                    if (!everTop5[template]) {
                        everTop5[template] = { count: 0, dates: [] };
                    }
                    everTop5[template].count++;
                    everTop5[template].dates.push(date);
                }
            });
            
            // Find peak and worst days
            var peakDay = dates[0];
            var peakProjects = dailyTotals[dates[0]];
            var worstDay = dates[1];
            var worstProjects = dailyTotals[dates[1]];
            
            for (var i = 0; i < dates.length; i++) {
                if (dailyTotals[dates[i]] > peakProjects) {
                    peakDay = dates[i];
                    peakProjects = dailyTotals[dates[i]];
                }
                if (i > 0 && dailyTotals[dates[i]] < worstProjects) {
                    worstDay = dates[i];
                    worstProjects = dailyTotals[dates[i]];
                }
            }
            
            document.getElementById('total-templates').textContent = templates.length;
            document.getElementById('total-projects').textContent = grandTotal.toLocaleString();
            document.getElementById('date-range').textContent = dates[0] + ' to ' + dates[dates.length - 1];
            document.getElementById('avg-daily').textContent = (grandTotal / dates.length).toFixed(0);
            document.getElementById('peak-day').textContent = peakDay + ' (' + peakProjects.toLocaleString() + ')';
            document.getElementById('worst-day').textContent = worstDay + ' (' + worstProjects.toLocaleString() + ')';
            
            // Overall top 5
            var top5Html = '';
            for (var i = 0; i < Math.min(5, totals.length); i++) {
                var percent = (totals[i].total / grandTotal * 100).toFixed(1);
                top5Html += '<div class="top-template-item rank-' + (i+1) + '">' +
                    '<span class="top-template-rank">#' + (i+1) + '</span>' +
                    '<span class="top-template-name">' + totals[i].template + '</span>' +
                    '<span class="top-template-value">' + totals[i].total.toLocaleString() + ' (' + percent + '%)</span></div>';
            }
            document.getElementById('top-templates-list').innerHTML = top5Html;
            
            // Ever in top 5
            var everTop5Array = Object.keys(everTop5).map(function(t) {
                return { template: t, daysInTop5: everTop5[t].count, dates: everTop5[t].dates };
            }).sort(function(a, b) { return b.daysInTop5 - a.daysInTop5; });
            
            var everTop5Html = '';
            everTop5Array.forEach(function(item, i) {
                var consistency = (item.daysInTop5 / dates.length * 100).toFixed(0);
                everTop5Html += '<div class="top-template-item">' +
                    '<span class="top-template-name">' + item.template + '</span>' +
                    '<span class="top-template-value">' + item.daysInTop5 + ' days (' + consistency + '%)</span></div>';
            });
            document.getElementById('ever-top5-list').innerHTML = everTop5Html || '<div style="color: #9b9a97; font-size: 12px;">No data</div>';
            
            createChart(data, dates, totals);
            generateInsights(data, dates, totals, grandTotal, dailyTotals, peakDay, worstDay, everTop5Array);
            document.getElementById('time-results').classList.remove('hidden');
        }
        
        function createChart(data, dates, totals) {
            var ctx = document.getElementById('timeChart');
            if (myChart) myChart.destroy();
            
            var displayDates = dates;
            if (dates.length > 15) {
                var skip = Math.ceil(dates.length / 15);
                displayDates = dates.filter(function(d, i) { return i % skip === 0 || i === dates.length - 1; });
            }
            
            var colors = ['#0061cc', '#0f7b6c', '#d9730d', '#9065b0', '#e03e3e', '#0d9488', '#7c3aed', '#db2777', '#ea580c', '#0891b2'];
            var datasets = [];
            
            for (var i = 0; i < Math.min(10, totals.length); i++) {
                var template = totals[i].template;
                var values = displayDates.map(function(d) { return data[template][d] || 0; });
                
                datasets.push({
                    label: template.substring(0, 25),
                    data: values,
                    borderColor: colors[i],
                    backgroundColor: colors[i] + '20',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: false,
                    pointRadius: 2,
                    pointHoverRadius: 4
                });
            }
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels: displayDates, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#e9e9e7', font: { size: 10 }, boxWidth: 12, padding: 8 }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#9b9a97', maxRotation: 45, font: { size: 9 } }, grid: { color: '#37352f' } },
                        y: { ticks: { color: '#9b9a97', font: { size: 10 } }, grid: { color: '#37352f' } }
                    }
                }
            });
        }
        
        function generateInsights(data, dates, totals, grandTotal, dailyTotals, peakDay, worstDay, everTop5Array) {
            var insights = [];
            var top = totals[0];
            insights.push('success|' + top.template + ' dominates with ' + top.total.toLocaleString() + ' projects (' + (top.total / grandTotal * 100).toFixed(1) + '% of total)');
            
            // Top 5 consistency analysis
            var consistentTop5 = everTop5Array.filter(function(t) { return t.daysInTop5 >= dates.length * 0.8; });
            var volatileTop5 = everTop5Array.filter(function(t) { return t.daysInTop5 < dates.length * 0.3 && t.daysInTop5 > 0; });
            
            if (consistentTop5.length > 0) {
                insights.push('success|' + consistentTop5.length + ' template(s) maintained top 5 position on 80%+ of days - strong consistent performers');
            }
            
            if (volatileTop5.length > 3) {
                insights.push('warning|' + volatileTop5.length + ' templates appeared in top 5 briefly then dropped off - high volatility in performance');
            }
            
            if (everTop5Array.length > 8) {
                insights.push('info|' + everTop5Array.length + ' different templates reached top 5 at some point - diverse performance across portfolio');
            } else if (everTop5Array.length <= 5) {
                insights.push('warning|Only ' + everTop5Array.length + ' templates ever reached top 5 - limited variety in top performers');
            }
            
            // Growth analysis
            var firstTotal = dailyTotals[dates[0]];
            var lastTotal = dailyTotals[dates[dates.length - 1]];
            var growth = ((lastTotal - firstTotal) / firstTotal * 100).toFixed(1);
            
            if (growth > 0) {
                insights.push('success|Overall growth of ' + growth + '% from first to last day');
            } else if (growth < 0) {
                insights.push('warning|Overall decline of ' + Math.abs(growth) + '% from first to last day');
            }
            
            // Peak analysis
            var peakProjects = dailyTotals[peakDay];
            var peakVsAvg = ((peakProjects / (grandTotal / dates.length)) - 1) * 100;
            if (peakVsAvg > 20) {
                insights.push('info|' + peakDay + ' peak was ' + peakVsAvg.toFixed(0) + '% above average - investigate what drove this spike');
            }
            
            // Volatility measure
            var dailyValues = dates.map(function(d) { return dailyTotals[d]; });
            var avg = grandTotal / dates.length;
            var variance = dailyValues.reduce(function(sum, val) { return sum + Math.pow(val - avg, 2); }, 0) / dates.length;
            var stdDev = Math.sqrt(variance);
            var coefficientOfVariation = (stdDev / avg * 100).toFixed(0);
            
            if (coefficientOfVariation > 25) {
                insights.push('warning|High daily volatility (CV: ' + coefficientOfVariation + '%) - usage patterns are unpredictable');
            } else if (coefficientOfVariation < 15) {
                insights.push('success|Low daily volatility (CV: ' + coefficientOfVariation + '%) - stable, predictable usage patterns');
            }
            
            // Weekday patterns
            var weekdayTotals = {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0};
            var weekdayCounts = {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0};
            
            dates.forEach(function(date) {
                var d = new Date(date);
                var day = d.getDay();
                weekdayTotals[day] += dailyTotals[date];
                weekdayCounts[day]++;
            });
            
            var dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            var avgByDay = [];
            for (var i = 0; i < 7; i++) {
                if (weekdayCounts[i] > 0) {
                    avgByDay.push({ day: dayNames[i], avg: weekdayTotals[i] / weekdayCounts[i], dayNum: i });
                }
            }
            
            if (avgByDay.length >= 5) {
                avgByDay.sort(function(a, b) { return b.avg - a.avg; });
                var bestDay = avgByDay[0];
                var worstWeekday = avgByDay[avgByDay.length - 1];
                var dayDiff = ((bestDay.avg - worstWeekday.avg) / worstWeekday.avg * 100).toFixed(0);
                
                if (dayDiff > 15) {
                    insights.push('info|' + bestDay.day + 's perform ' + dayDiff + '% better than ' + worstWeekday.day + 's - consider timing releases accordingly');
                }
            }
            
            // Trend analysis
            var midpoint = Math.floor(dates.length / 2);
            var firstHalfTotal = 0, secondHalfTotal = 0;
            
            for (var i = 0; i < midpoint; i++) firstHalfTotal += dailyTotals[dates[i]];
            for (var i = midpoint; i < dates.length; i++) secondHalfTotal += dailyTotals[dates[i]];
            
            var trendChange = ((secondHalfTotal / (dates.length - midpoint)) - (firstHalfTotal / midpoint)) / (firstHalfTotal / midpoint) * 100;
            
            if (trendChange > 10) {
                insights.push('success|Strong upward trend - second half averaging ' + trendChange.toFixed(1) + '% higher than first half');
            } else if (trendChange < -10) {
                insights.push('warning|Declining trend - second half averaging ' + Math.abs(trendChange).toFixed(1) + '% lower than first half');
            }
            
            // Concentration analysis
            var top5Total = totals.slice(0, 5).reduce(function(sum, t) { return sum + t.total; }, 0);
            var top5Pct = (top5Total / grandTotal * 100).toFixed(1);
            
            if (top5Pct > 80) {
                insights.push('warning|Top 5 dominate with ' + top5Pct + '% of projects - portfolio heavily concentrated');
            } else if (top5Pct < 50) {
                insights.push('success|Well-distributed portfolio - top 5 only account for ' + top5Pct + '% of projects');
            } else {
                insights.push('info|Top 5 templates account for ' + top5Pct + '% of all projects');
            }
            
            document.getElementById('time-insights').innerHTML = insights.map(function(i) {
                var p = i.split('|');
                return '<div class="insight ' + p[0] + '">' + p[1] + '</div>';
            }).join('');
        }
    </script>
</body>
</html>
